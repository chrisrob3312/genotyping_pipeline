/*
================================================================================
    OUR PIPELINE VARIANT F: 2-Step Imputation with All of Us
================================================================================
    Full 2-step imputation using All of Us AnVIL server.

    Pipeline Flow:
      Module 1: Union merge within platform → Minimal QC → Prep for imputation
      Module 2: Submit to All of Us AnVIL (1st imputation - PASS 1)
      Module 3: Download results → MagicalRsq-X filter (PASS 1)
      Module 4: Intersect merge across platforms → Call rate adjustment
      Module 5: Re-imputation (2nd imputation - PASS 2)
      Module 6: MagicalRsq-X filter (PASS 2) → Thorough QC
      Module 7: GRAF-anc ancestry classification

    KEY WORKFLOW (2-step):
      - MagicalRsq-X applied after EACH imputation step (PASS 1 and PASS 2)
      - Call rate adjustment before 2nd imputation
      - Re-imputation fills gaps from platform merge

    Expected: Best for Latino/admixed populations due to:
    - All of Us has strong Hispanic/Latino representation
    - 2-step recovers variants lost in first pass
    - MagicalRsq-X doesn't penalize non-EUR samples
================================================================================
*/

params {
    // Benchmark identification
    benchmark_name = 'ours_2step_allofus'
    benchmark_description = 'Our pipeline (2-step imputation) with All of Us'

    // ========== Our Pipeline Approach ==========

    // Module 2: First Imputation
    run_topmed = false
    run_anvil = true                // All of Us AnVIL

    // Module 5: Re-imputation (2-step)
    skip_reimputation = false       // Enable re-imputation
    run_topmed_reimputation = false
    run_anvil_reimputation = true   // Re-impute with All of Us

    // Module 3 & 6: QC Settings
    skip_hwe = true                 // Skip HWE (admixed populations)
    use_magicalrsq = true
    magicalrsq_threshold = 0.3

    // Call rate thresholds (applied AFTER imputation)
    sample_call_rate = 0.95
    variant_call_rate = 0.95

    // Relatedness
    use_genesis = true              // GENESIS PCRelate (better for admixed)
    kinship_threshold = 0.177       // 1st-degree

    // Ancestry settings
    primary_ancestry = 'AMR'

    // Output
    outdir = 'results/benchmark_ours_2step_allofus'
}

profiles {
    benchmark {
        process {
            beforeScript = 'echo "START $(date +%s)" >> ${task.workDir}/timing.log'
            afterScript = 'echo "END $(date +%s)" >> ${task.workDir}/timing.log'
        }
    }
}
