Bootstrap: docker
From: ubuntu:22.04

%labels
    Author Christina Robinson
    Version 1.0
    Description ADMIXTURE + RFMix v1/v2 + FLARE + G-NOMIX for ancestry analysis

%help
    This container provides:
    - ADMIXTURE: Global ancestry estimation
    - RFMix v1: Local ancestry inference (older version)
    - RFMix v2: Local ancestry inference (newer version)
    - FLARE: Fast Local Ancestry Estimation
    - G-NOMIX: Graph-based local ancestry inference
    - bcftools, PLINK for data manipulation
    - Python 3 with numpy, pandas, scipy
    
    Used in Module 7 (Ancestry Estimation)

%post
    # Set non-interactive installation
    export DEBIAN_FRONTEND=noninteractive
    
    # Update and install system dependencies
    apt-get update && apt-get install -y \
        wget \
        curl \
        git \
        build-essential \
        cmake \
        autoconf \
        automake \
        libtool \
        pkg-config \
        python3 \
        python3-pip \
        python3-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libncurses5-dev \
        unzip \
        gfortran \
        libopenblas-dev \
        liblapack-dev \
        && rm -rf /var/lib/apt/lists/*
    
    # Install Python scientific computing libraries
    pip3 install --no-cache-dir \
        numpy \
        pandas \
        scipy \
        scikit-learn \
        matplotlib
    
    # Install bcftools for VCF manipulation
    cd /opt
    wget https://github.com/samtools/bcftools/releases/download/1.18/bcftools-1.18.tar.bz2
    tar -xjf bcftools-1.18.tar.bz2
    cd bcftools-1.18
    ./configure --prefix=/usr/local
    make
    make install
    cd /opt
    rm -rf bcftools-1.18 bcftools-1.18.tar.bz2
    
    # Install PLINK 1.9
    cd /opt
    wget https://s3.amazonaws.com/plink1-assets/plink_linux_x86_64_20231211.zip
    unzip plink_linux_x86_64_20231211.zip
    mv plink /usr/local/bin/
    chmod +x /usr/local/bin/plink
    rm plink_linux_x86_64_20231211.zip
    
    # ========================================================================
    # INSTALL ADMIXTURE
    # ========================================================================
    echo "Installing ADMIXTURE..."
    cd /opt
    wget http://dalexander.github.io/admixture/binaries/admixture_linux-1.3.0.tar.gz
    tar -xzf admixture_linux-1.3.0.tar.gz
    cd admixture_linux-1.3.0
    mv admixture /usr/local/bin/
    mv admixture32 /usr/local/bin/ 2>/dev/null || true
    cd /opt
    rm -rf admixture_linux-1.3.0 admixture_linux-1.3.0.tar.gz
    
    # ========================================================================
    # INSTALL RFMIX v1
    # ========================================================================
    echo "Installing RFMix v1..."
    cd /opt
    git clone https://github.com/slowkoni/rfmix.git rfmix_v1
    cd rfmix_v1
    # RFMix v1 is in the original branch
    # Compile
    cd RFMIX_v1.5.4
    make
    cp RunRFMix.py /usr/local/bin/rfmix_v1
    chmod +x /usr/local/bin/rfmix_v1
    
    # ========================================================================
    # INSTALL RFMIX v2
    # ========================================================================
    echo "Installing RFMix v2..."
    cd /opt
    git clone https://github.com/slowkoni/rfmix.git rfmix_v2
    cd rfmix_v2
    # RFMix v2 uses different build system
    autoreconf --force --install
    ./configure --prefix=/usr/local
    make
    make install
    
    # ========================================================================
    # INSTALL FLARE
    # ========================================================================
    echo "Installing FLARE..."
    cd /opt
    git clone https://github.com/browning-lab/flare.git
    cd flare
    # FLARE is Java-based, but we'll make sure javac is available
    apt-get update && apt-get install -y default-jdk && rm -rf /var/lib/apt/lists/*
    # Compile if needed
    if [ -f "build.sh" ]; then
        bash build.sh
    fi
    # Make available in PATH
    echo '#!/bin/bash' > /usr/local/bin/flare
    echo 'java -jar /opt/flare/flare.jar "$@"' >> /usr/local/bin/flare
    chmod +x /usr/local/bin/flare
    
    # ========================================================================
    # INSTALL G-NOMIX (if available publicly)
    # ========================================================================
    echo "Installing G-NOMIX..."
    cd /opt
    # G-NOMIX may need to be cloned from the appropriate repository
    # Placeholder for when repository URL is confirmed
    git clone https://github.com/AI-sandbox/gnomix.git gnomix || \
        echo "NOTE: G-NOMIX repository not publicly available - manual installation may be required"
    
    if [ -d "gnomix" ]; then
        cd gnomix
        pip3 install --no-cache-dir -e .
    fi
    
    # Verify installations
    echo "=== Verifying installations ==="
    python3 --version || echo "ERROR: Python installation failed"
    bcftools --version || echo "ERROR: bcftools installation failed"
    plink --version || echo "ERROR: PLINK installation failed"
    admixture --version || echo "ERROR: ADMIXTURE installation failed"
    which rfmix_v1 || echo "ERROR: RFMix v1 installation failed"
    rfmix --version || echo "ERROR: RFMix v2 installation failed"
    which flare || echo "ERROR: FLARE installation failed"

%environment
    export LC_ALL=C
    export PATH=/usr/local/bin:$PATH
    export JAVA_HOME=/usr/lib/jvm/default-java

%runscript
    echo "Ancestry Suite container"
    echo "Available tools: admixture, rfmix_v1, rfmix (v2), flare, bcftools, plink"
    exec "$@"

%test
    # Test all critical tools
    python3 --version
    bcftools --version
    plink --version
    admixture --version
    which rfmix_v1
    rfmix --version
    which flare
