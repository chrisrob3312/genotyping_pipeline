Bootstrap: docker
From: rocker/r-ver:4.3.0

%labels
    Author Christina Robinson
    Version 2.0
    Description R + GENESIS + MagicalRsq-X + tidyverse for QC and imputation quality assessment

%help
    This container provides:
    - R 4.3.0
    - GENESIS: Genetic association testing framework
    - GWASTools: Quality control and analysis tools
    - MagicalRsq-X: Integrated imputation quality filtering with pre-trained models
    - tidyverse: Data manipulation and visualization
    - data.table: Fast data processing
    
    MagicalRsq-X is fully integrated with all scripts and pre-trained models included.
    
    Used in Modules 3, 6, and 7 (Post-QC, Post-Merge QC, Analysis)

%post
    # Install system dependencies for R packages and git
    apt-get update && apt-get install -y \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libfontconfig1-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libgit2-dev \
        libssh2-1-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        git \
        wget \
        curl \
        && rm -rf /var/lib/apt/lists/*
    
    # Install BiocManager for Bioconductor packages
    R -e "install.packages('BiocManager', repos='https://cloud.r-project.org/')"
    
    # Install Bioconductor packages
    # GENESIS and its dependencies
    R -e "BiocManager::install(c( \
        'GENESIS', \
        'GWASTools', \
        'SNPRelate', \
        'SeqArray', \
        'SeqVarTools', \
        'Biobase', \
        'BiocGenerics' \
    ), ask=FALSE, update=FALSE)"
    
    # Install CRAN packages (including MagicalRsq-X dependencies)
    R -e "install.packages(c( \
        'tidyverse', \
        'data.table', \
        'ggplot2', \
        'dplyr', \
        'readr', \
        'tidyr', \
        'purrr', \
        'stringr', \
        'forcats', \
        'xgboost', \
        'Matrix', \
        'optparse', \
        'jsonlite' \
    ), repos='https://cloud.r-project.org/')"
    
    # ========================================================================
    # INSTALL MAGICALRSQ-X
    # Reference: https://github.com/quansun98/MagicalRsqX
    # Publication: Sun Q et al., AJHG 2024
    # ========================================================================
    echo "Installing MagicalRsq-X..."
    cd /opt

    # Clone the MagicalRsq-X repository (correct URL)
    git clone https://github.com/quansun98/MagicalRsqX.git
    cd MagicalRsqX

    # MagicalRsq-X uses R scripts with XGBoost models
    # Make scripts executable
    chmod +x *.R 2>/dev/null || true
    chmod +x scripts/*.R 2>/dev/null || true

    # Create symbolic links for main scripts
    if [ -f "MagicalRsqX.R" ]; then
        ln -s /opt/MagicalRsqX/MagicalRsqX.R /usr/local/bin/magicalrsqx
        chmod +x /usr/local/bin/magicalrsqx
    fi

    # Download pre-trained models from FTP
    echo "Downloading pre-trained XGBoost models..."
    mkdir -p models
    cd models

    # Download models for different ancestry groups
    # Models available: EUR, AFR, AMR, EAS (trained on TOPMed cohorts)
    wget -q ftp://yunlianon:anon@ftp.biostat.wisc.edu/MagicalRsqX/models/EUR_model.rds || echo "EUR model download attempted"
    wget -q ftp://yunlianon:anon@ftp.biostat.wisc.edu/MagicalRsqX/models/AFR_model.rds || echo "AFR model download attempted"
    wget -q ftp://yunlianon:anon@ftp.biostat.wisc.edu/MagicalRsqX/models/AMR_model.rds || echo "AMR model download attempted"
    wget -q ftp://yunlianon:anon@ftp.biostat.wisc.edu/MagicalRsqX/models/EAS_model.rds || echo "EAS model download attempted"

    # Also try alternative model location in repo
    cd /opt/MagicalRsqX
    if [ -d "trained_models" ]; then
        echo "Found trained_models directory in repo"
        cp -r trained_models/* models/ 2>/dev/null || true
    fi

    # Set environment variable for MagicalRsq-X location
    echo 'export MAGICALRSQX_HOME="/opt/MagicalRsqX"' >> /etc/environment
    
    # Verify installations
    echo "=== Verifying R package installations ==="
    R -e "library(GENESIS); packageVersion('GENESIS')" || echo "ERROR: GENESIS installation failed"
    R -e "library(GWASTools); packageVersion('GWASTools')" || echo "ERROR: GWASTools installation failed"
    R -e "library(tidyverse); packageVersion('tidyverse')" || echo "ERROR: tidyverse installation failed"
    R -e "library(data.table); packageVersion('data.table')" || echo "ERROR: data.table installation failed"
    R -e "library(xgboost); packageVersion('xgboost')" || echo "ERROR: xgboost installation failed"
    R -e "library(ggplot2); packageVersion('ggplot2')" || echo "ERROR: ggplot2 installation failed"
    R -e "library(jsonlite); packageVersion('jsonlite')" || echo "ERROR: jsonlite installation failed"
    
    echo "=== Verifying MagicalRsq-X installation ==="
    ls -la /opt/MagicalRsqX/ || echo "WARNING: MagicalRsq-X directory not found"
    ls -la /opt/MagicalRsqX/models/ || echo "WARNING: MagicalRsq-X models not found"
    echo "MagicalRsq-X location: /opt/MagicalRsqX"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export MAGICALRSQX_HOME="/opt/MagicalRsqX"
    export PATH="/opt/MagicalRsqX:/opt/MagicalRsqX/scripts:$PATH"

%runscript
    echo "R Genetics container (GENESIS + MagicalRsq-X + tidyverse)"
    echo "Available commands: R, Rscript, magicalrsqx"
    echo "MagicalRsq-X location: /opt/MagicalRsqX"
    echo "MagicalRsq-X models: /opt/MagicalRsqX/models"
    exec "$@"

%test
    # Test all critical packages
    R --version
    R -e "library(GENESIS)"
    R -e "library(GWASTools)"
    R -e "library(tidyverse)"
    R -e "library(data.table)"
    R -e "library(xgboost)"
    R -e "library(ggplot2)"
    R -e "library(jsonlite)"

    # Test MagicalRsq-X installation
    test -d /opt/MagicalRsqX
    ls /opt/MagicalRsqX/
