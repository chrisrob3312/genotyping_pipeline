Bootstrap: docker
From: ubuntu:22.04

%labels
    Author Christina Robinson
    Version 1.0
    Description Perl + CrossMap + PLINK + bcftools for Module 1

%help
    This container provides:
    - Perl 5.x for Will Rayner's strand checking script
    - CrossMap for genome coordinate conversion (hg19 â†’ hg38)
    - PLINK 1.9 for genetic data format conversion
    - bcftools for VCF manipulation
    
    Used in Module 1 (Pre-Imputation QC)

%post
    # Set non-interactive installation
    export DEBIAN_FRONTEND=noninteractive
    
    # Update and install base dependencies
    apt-get update && apt-get install -y \
        perl \
        perl-base \
        perl-modules-5.34 \
        python3 \
        python3-pip \
        wget \
        curl \
        git \
        build-essential \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        libcurl4-openssl-dev \
        libssl-dev \
        libncurses5-dev \
        unzip \
        && rm -rf /var/lib/apt/lists/*
    
    # Install CrossMap via pip
    pip3 install --no-cache-dir CrossMap
    
    # Install PLINK 1.9
    cd /opt
    wget https://s3.amazonaws.com/plink1-assets/plink_linux_x86_64_20231211.zip
    unzip plink_linux_x86_64_20231211.zip
    mv plink /usr/local/bin/
    chmod +x /usr/local/bin/plink
    rm plink_linux_x86_64_20231211.zip
    
    # Install bcftools from source (ensures we get latest with all plugins)
    cd /opt
    wget https://github.com/samtools/bcftools/releases/download/1.18/bcftools-1.18.tar.bz2
    tar -xjf bcftools-1.18.tar.bz2
    cd bcftools-1.18
    ./configure --prefix=/usr/local
    make
    make install
    cd /opt
    rm -rf bcftools-1.18 bcftools-1.18.tar.bz2
    
    # Install htslib (includes tabix and bgzip)
    cd /opt
    wget https://github.com/samtools/htslib/releases/download/1.18/htslib-1.18.tar.bz2
    tar -xjf htslib-1.18.tar.bz2
    cd htslib-1.18
    ./configure --prefix=/usr/local
    make
    make install
    cd /opt
    rm -rf htslib-1.18 htslib-1.18.tar.bz2
    
    # Verify installations
    echo "=== Verifying installations ==="
    perl --version || echo "ERROR: Perl installation failed"
    python3 --version || echo "ERROR: Python installation failed"
    CrossMap -h || echo "ERROR: CrossMap installation failed"
    plink --version || echo "ERROR: PLINK installation failed"
    bcftools --version || echo "ERROR: bcftools installation failed"
    tabix --version || echo "ERROR: tabix installation failed"
    bgzip --version || echo "ERROR: bgzip installation failed"

%environment
    export LC_ALL=C
    export PATH=/usr/local/bin:$PATH

%runscript
    echo "Perl + CrossMap + PLINK + bcftools container"
    echo "Available commands: perl, python3, CrossMap, plink, bcftools, tabix, bgzip"
    exec "$@"

%test
    # Test all critical tools
    perl --version
    python3 --version
    CrossMap -h
    plink --version
    bcftools --version
    tabix --version
    bgzip --version
