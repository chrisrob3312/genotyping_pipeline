Bootstrap: docker
From: rocker/r-ver:4.3.0

%labels
    Author Christina Robinson
    Version 1.0
    Description R + GENESIS + MagicalRsq + tidyverse for QC and imputation quality assessment

%help
    This container provides:
    - R 4.3.0
    - GENESIS: Genetic association testing framework
    - GWASTools: Quality control and analysis tools
    - MagicalRsq-X dependencies: XGBoost for imputation quality filtering
    - tidyverse: Data manipulation and visualization
    - data.table: Fast data processing
    
    Used in Modules 3, 6, and 7 (Post-QC, Post-Merge QC, Analysis)

%post
    # Install system dependencies for R packages
    apt-get update && apt-get install -y \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libfontconfig1-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libgit2-dev \
        libssh2-1-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev \
        git \
        wget \
        && rm -rf /var/lib/apt/lists/*
    
    # Install BiocManager for Bioconductor packages
    R -e "install.packages('BiocManager', repos='https://cloud.r-project.org/')"
    
    # Install Bioconductor packages
    # GENESIS and its dependencies
    R -e "BiocManager::install(c( \
        'GENESIS', \
        'GWASTools', \
        'SNPRelate', \
        'SeqArray', \
        'SeqVarTools', \
        'Biobase', \
        'BiocGenerics' \
    ), ask=FALSE, update=FALSE)"
    
    # Install CRAN packages
    R -e "install.packages(c( \
        'tidyverse', \
        'data.table', \
        'ggplot2', \
        'dplyr', \
        'readr', \
        'tidyr', \
        'purrr', \
        'stringr', \
        'forcats', \
        'xgboost', \
        'Matrix', \
        'optparse' \
    ), repos='https://cloud.r-project.org/')"
    
    # Verify installations
    echo "=== Verifying R package installations ==="
    R -e "library(GENESIS); packageVersion('GENESIS')" || echo "ERROR: GENESIS installation failed"
    R -e "library(GWASTools); packageVersion('GWASTools')" || echo "ERROR: GWASTools installation failed"
    R -e "library(tidyverse); packageVersion('tidyverse')" || echo "ERROR: tidyverse installation failed"
    R -e "library(data.table); packageVersion('data.table')" || echo "ERROR: data.table installation failed"
    R -e "library(xgboost); packageVersion('xgboost')" || echo "ERROR: xgboost installation failed"
    R -e "library(ggplot2); packageVersion('ggplot2')" || echo "ERROR: ggplot2 installation failed"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%runscript
    echo "R Genetics container (GENESIS + MagicalRsq + tidyverse)"
    echo "Available commands: R, Rscript"
    exec "$@"

%test
    # Test all critical packages
    R --version
    R -e "library(GENESIS)"
    R -e "library(GWASTools)"
    R -e "library(tidyverse)"
    R -e "library(data.table)"
    R -e "library(xgboost)"
    R -e "library(ggplot2)"
