/*
================================================================================
    Nextflow Configuration File
    Genotyping QC, Imputation, and Ancestry Pipeline
================================================================================
    Comprehensive configuration for HPC and Cloud environments
    Supports: SLURM, PBS, Google Cloud, AWS, local execution
    Containers: Apptainer/Singularity
================================================================================
*/

// ============================================================================
// GENERAL PARAMETERS
// ============================================================================

params {
    // ========== Input/Output ==========
    sample_sheet                = null                    // Required: CSV (see documentation/input_file_set_up.md)
    outdir                      = 'results'               // Output directory
    input_build                 = 'hg19'                  // Input genome build: hg19 or hg38
    skip_modules                = ''                      // Comma-separated modules to skip (e.g., "5,7")
    
    // ========== Reference Files ==========
    hg19_fasta                  = 'resources/references/hg19.fa'
    hg38_fasta                  = 'resources/references/hg38.fa'
    reference_fasta             = 'resources/references/hg38.fa'  // Alias for hg38_fasta
    liftover_chain              = 'resources/references/hg19ToHg38.over.chain.gz'
    topmed_reference            = 'resources/references/PASS.Variants.TOPMed_freeze10_hg38.tab.gz'
    strand_check_script         = "${projectDir}/helper_scripts/check_strand_topmed.pl"
    
    // ========== Helper Scripts ==========
    magicalrsq_filter_script    = "${projectDir}/helper_scripts/magicalrsq_filter.R"
    magicalrsq_models_dir       = 'resources/magicalrsq_models'
    
    // ========== Module 2 & 5: Imputation Services ==========
    run_topmed                  = true                    // Enable TOPMed imputation
    run_anvil                   = false                   // Enable All of Us AnVIL imputation
    monitor_interval_minutes    = 45                      // Monitoring interval for imputation jobs (minutes)

    // TOPMed Imputation Server (https://imputation.biodatacatalyst.nhlbi.nih.gov)
    // Get API token from the TOPMed imputation server web interface
    topmed_api_token            = null                    // TOPMed API token (required if run_topmed=true)
    topmed_password             = null                    // Password for auto-decrypt (set your own strong password)

    // All of Us / AnVIL Imputation Service (https://allofus-anvil-imputation.terra.bio)
    // IMPORTANT: Before running with run_anvil=true, you MUST authenticate:
    //   1. Install terralab-cli: pip install terralab-cli
    //   2. Run interactively:    terralab login  (opens browser for OAuth)
    //   3. Credentials stored in ~/.config/terralab/ are used by pipeline
    // For HPC: Run 'terralab login' on login node before submitting jobs
    
    // ========== Module 3 & 6: QC Thresholds ==========
    magicalrsq_threshold        = 0.3                     // MagicalRsq-X RÂ² threshold
    sample_call_rate            = 0.95                    // Minimum sample call rate
    variant_call_rate           = 0.95                    // Minimum variant call rate
    hwe_pvalue                  = 1e-6                    // HWE filter p-value
    het_sd_threshold            = 3                       // Heterozygosity SD threshold
    
    // ========== Module 6: Relatedness ==========
    use_genesis                 = true                    // Use GENESIS PCRelate (true) or PLINK (false)
    kinship_threshold           = 0.177                   // 1st-degree relatedness threshold
    
    // ========== Module 7: Ancestry Estimation ==========
    reference_panel             = 'resources/ancestry_references/reference_panel.rds'
    genetic_map_dir             = 'resources/genetic_maps'
    admixture_k                 = '5,6,7'                 // ADMIXTURE K values

    // Local Ancestry Inference (LAI) - Optional
    run_lai                     = false                   // Enable local ancestry inference
    lai_methods                 = 'rfmix2'                // LAI methods: rfmix2,rfmix1,flare,gnomix (comma-separated)

    // LAI Reference (SHARED: RFMix v2, FLARE, G-NOMIX use same VCF, different sample maps)
    // Created by helper_scripts/format_reference_panel.sh
    lai_reference_dir           = 'resources/ancestry_references/lai_reference'

    // RFMix v2 parameters (default LAI tool)
    // Reference: https://github.com/slowkoni/rfmix
    rfmix_reference_vcf         = "${params.lai_reference_dir}/reference_haplotypes.vcf.gz"
    rfmix_reference_map         = "${params.lai_reference_dir}/rfmix2_sample_map.txt"
    rfmix_em_iterations         = 5                       // EM optimization iterations

    // FLARE parameters
    // Reference: https://github.com/browning-lab/flare
    flare_reference_vcf         = "${params.lai_reference_dir}/reference_haplotypes.vcf.gz"
    flare_panel_file            = "${params.lai_reference_dir}/flare_panels.txt"

    // G-NOMIX parameters
    // Reference: https://github.com/AI-sandbox/gnomix
    // For inference: point to pre-trained model directory
    // For training: use lai_reference_dir VCF + gnomix_sample_map.tsv
    gnomix_model_dir            = 'resources/ancestry_references/gnomix_models'
    gnomix_sample_map           = "${params.lai_reference_dir}/gnomix_sample_map.tsv"

    // RFMix v1 parameters (legacy, per-chromosome format)
    // Reference: https://sites.google.com/site/rfmixlocalancestryinference/
    // See also: https://github.com/armartin/ancestry_pipeline
    // Created by helper_scripts/convert_vcf_to_rfmix1.py
    rfmix1_reference_dir        = 'resources/ancestry_references/rfmix1'
    rfmix1_reference_alleles    = "${params.rfmix1_reference_dir}/rfmix1_reference_chr{chr}.alleles"
    rfmix1_reference_classes    = "${params.rfmix1_reference_dir}/rfmix1_reference_chr{chr}.classes"
    rfmix1_snp_locations        = "${params.rfmix1_reference_dir}/rfmix1_reference_chr{chr}.snp_locations"

    // GRAF-anc parameters
    // Reference: https://github.com/jimmy-penn/grafanc
    // Requires AncSnpPopAFs.txt in grafanc_data_dir
    grafanc_data_dir            = 'resources/grafanc_data'

    // ========== Resource Limits ==========
    max_cpus                    = 32
    max_memory                  = '128.GB'
    max_time                    = '240.h'
    
    // ========== Execution Options ==========
    help                        = false
    tracedir                    = "${params.outdir}/pipeline_info"
}

// ============================================================================
// PROCESS RESOURCE LABELS
// ============================================================================

process {
    // Default resources
    cpus   = 1
    memory = 4.GB
    time   = 4.h
    
    // ========== Container Definitions ==========
    // All processes use Apptainer containers
    
    withLabel: 'plink' {
        container = 'resources/containers/plink_1.9.sif'
        cpus   = 4
        memory = 16.GB
        time   = 2.h
    }

    withLabel: 'plink_merge' {
        container = 'resources/containers/plink_1.9.sif'
        cpus   = 8
        memory = 32.GB
        time   = 4.h
    }

    withLabel: 'plink_large' {
        container = 'resources/containers/plink_1.9.sif'
        cpus   = 16
        memory = 64.GB
        time   = 8.h
    }

    withLabel: 'vcftools' {
        container = 'resources/containers/bcftools.sif'
        cpus   = 4
        memory = 16.GB
        time   = 2.h
    }

    withLabel: 'r_genetics' {
        container = 'resources/containers/r_genetics.sif'
        cpus   = 4
        memory = 16.GB
        time   = 4.h
    }

    withLabel: 'r_large' {
        container = 'resources/containers/r_genetics.sif'
        cpus   = 8
        memory = 32.GB
        time   = 8.h
    }

    withLabel: 'python_api' {
        container = 'resources/containers/python_api.sif'
        cpus   = 1
        memory = 4.GB
        time   = 24.h
        maxRetries = 3
        errorStrategy = 'retry'
    }

    withLabel: 'ancestry_tools' {
        container = 'resources/containers/ancestry_suite.sif'
        cpus   = 8
        memory = 32.GB
        time   = 12.h
    }

    withLabel: 'admixture' {
        container = 'resources/containers/ancestry_suite.sif'
        cpus   = 4
        memory = 16.GB
        time   = 8.h
    }

    withLabel: 'rfmix' {
        container = 'resources/containers/ancestry_suite.sif'
        cpus   = 8
        memory = 24.GB
        time   = 12.h
    }
    
    withLabel: 'download' {
        cpus   = 1
        memory = 4.GB
        time   = 12.h
    }
    
    withLabel: 'process_low' {
        cpus   = 2
        memory = 8.GB
        time   = 2.h
    }
    
    withLabel: 'process_medium' {
        cpus   = 4
        memory = 16.GB
        time   = 4.h
    }
    
    withLabel: 'process_high' {
        cpus   = 8
        memory = 32.GB
        time   = 8.h
    }
    
    withLabel: 'merge_samples' {
        container = 'resources/containers/plink_1.9.sif'
        cpus   = 8
        memory = 32.GB
        time   = 6.h
    }
}

// ============================================================================
// EXECUTION PROFILES
// ============================================================================

profiles {
    // ========== Apptainer/Singularity Profile ==========
    apptainer {
        apptainer.enabled    = true
        apptainer.autoMounts = true
        apptainer.runOptions = '--cleanenv --containall'
        
        process {
            containerOptions = '--bind ${PWD}:${PWD}'
        }
    }
    
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        singularity.runOptions = '--cleanenv --containall'
        
        process {
            containerOptions = '--bind ${PWD}:${PWD}'
        }
    }
    
    // ========== Docker Profile (for local testing) ==========
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    // ========== SLURM Cluster Profile ==========
    slurm {
        process {
            executor = 'slurm'
            queue = 'general'
            clusterOptions = '--account=your_account'
        }
        
        executor {
            queueSize = 100
            submitRateLimit = '10 sec'
        }
    }
    
    // ========== PBS/Torque Profile ==========
    pbs {
        process {
            executor = 'pbs'
            queue = 'batch'
        }
        
        executor {
            queueSize = 100
            submitRateLimit = '10 sec'
        }
    }
    
    // ========== Google Cloud (All of Us AnVIL) ==========
    google {
        process {
            executor = 'google-lifesciences'
            container = 'gcr.io/your-project/pipeline-image:latest'
        }
        
        google {
            project = params.anvil_project
            zone = 'us-central1-a'
            lifeSciences.bootDiskSize = 50.GB
        }
    }
    
    // ========== AWS Batch ==========
    aws {
        process {
            executor = 'awsbatch'
            queue = 'your-batch-queue'
            container = 'your-ecr-registry/pipeline-image:latest'
        }
        
        aws {
            region = 'us-east-1'
            batch.cliPath = '/home/ec2-user/miniconda/bin/aws'
        }
    }
    
    // ========== Test Profile (reduced resources) ==========
    test {
        params {
            max_cpus = 4
            max_memory = '16.GB'
            max_time = '2.h'
        }
        
        process {
            cpus = { check_max(1, 'cpus') }
            memory = { check_max(4.GB, 'memory') }
            time = { check_max(1.h, 'time') }
        }
    }
    
    // ========== Standard (local) Profile ==========
    standard {
        process.executor = 'local'
    }
}

// ============================================================================
// MANIFEST
// ============================================================================

manifest {
    name            = 'Genotyping-Imputation-Ancestry-Pipeline'
    author          = 'Your Name'
    homePage        = 'https://github.com/your-repo/pipeline'
    description     = 'Complete pipeline for genotyping QC, imputation, and ancestry estimation'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// ============================================================================
// EXECUTION REPORTING
// ============================================================================

timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline.html"
}

report {
    enabled = true
    file    = "${params.tracedir}/execution_report.html"
}

trace {
    enabled = true
    file    = "${params.tracedir}/execution_trace.txt"
}

dag {
    enabled = true
    file    = "${params.tracedir}/pipeline_dag.html"
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

// Function to check max resources
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "WARNING: Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
