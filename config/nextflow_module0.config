/*
 * ============================================================================
 * MODULE 0 CONFIGURATION
 * ============================================================================
 * Configuration for container building and verification
 */

params {
    // ========================================================================
    // OUTPUT DIRECTORIES
    // ========================================================================
    outdir = "containers"  // Where to save built containers
    
    // ========================================================================
    // INPUT FILES
    // ========================================================================
    def_dir = "container_definitions"  // Directory containing .def files
    verify_script = "scripts/verify_containers.sh"  // Container verification script
    
    // ========================================================================
    // APPTAINER/SINGULARITY SETTINGS
    // ========================================================================
    apptainer_cache_dir = "${launchDir}/.apptainer_cache"
    
    // ========================================================================
    // RESOURCE ALLOCATION
    // ========================================================================
    // Most container builds are not resource-intensive
    // Adjust if building on systems with limited resources
    max_cpus = 4
    max_memory = '8.GB'
    max_time = '4.h'
}

// ============================================================================
// PROCESS-SPECIFIC CONFIGURATIONS
// ============================================================================
process {
    // Default resources for all processes
    cpus = 1
    memory = '4.GB'
    time = '2.h'
    
    // Specific process configurations
    withName: 'buildPlink19' {
        memory = '2.GB'
        time = '30.m'
    }
    
    withName: 'buildPlink20' {
        memory = '2.GB'
        time = '30.m'
    }
    
    withName: 'buildBcftools' {
        memory = '2.GB'
        time = '30.m'
    }
    
    withName: 'buildPerlCrossmap' {
        cpus = 2
        memory = '4.GB'
        time = '1.h'
    }
    
    withName: 'buildPythonAPI' {
        cpus = 2
        memory = '4.GB'
        time = '1.h'
    }
    
    withName: 'buildRGenetics' {
        cpus = 4
        memory = '8.GB'
        time = '2.h'
        // R packages can take longer to compile
    }
    
    withName: 'buildAncestrySuite' {
        cpus = 4
        memory = '8.GB'
        time = '2.h'
    }
    
    withName: 'validateContainers' {
        cpus = 1
        memory = '2.GB'
        time = '30.m'
    }
}

// ============================================================================
// EXECUTOR CONFIGURATIONS
// ============================================================================
executor {
    name = 'local'
    cpus = params.max_cpus
    memory = params.max_memory
}

// Uncomment and configure for SLURM execution
/*
executor {
    name = 'slurm'
    queueSize = 10
    submitRateLimit = '10 sec'
}

process {
    executor = 'slurm'
    queue = 'normal'
    clusterOptions = '--account=your_account'
}
*/

// Uncomment and configure for PBS execution
/*
executor {
    name = 'pbs'
    queueSize = 10
}

process {
    executor = 'pbs'
    queue = 'normal'
}
*/

// ============================================================================
// APPTAINER/SINGULARITY SETTINGS
// ============================================================================
apptainer {
    enabled = true
    autoMounts = true
    cacheDir = params.apptainer_cache_dir
    
    // Enable if you need to use --fakeroot for building
    // runOptions = '--fakeroot'
}

singularity {
    enabled = true
    autoMounts = true
    cacheDir = params.apptainer_cache_dir
}

// ============================================================================
// REPORTING
// ============================================================================
report {
    enabled = true
    file = "${params.outdir}/reports/module0_report.html"
}

timeline {
    enabled = true
    file = "${params.outdir}/reports/module0_timeline.html"
}

trace {
    enabled = true
    file = "${params.outdir}/reports/module0_trace.txt"
}

dag {
    enabled = true
    file = "${params.outdir}/reports/module0_dag.html"
}

// ============================================================================
// MANIFEST
// ============================================================================
manifest {
    name = 'Genotyping Pipeline - Module 0'
    author = 'Christina Robinson'
    description = 'Container builder with integrated verification'
    version = '1.0'
    nextflowVersion = '>=21.04.0'
}
